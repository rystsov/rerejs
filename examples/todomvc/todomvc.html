<html>
    <head>
        <script src="../require.js"></script>
        <script type="text/javascript">
            require.config({
                paths: {
                    "rere": "../../rerejs"
                }
            });
        </script>
    </head>
    <body>
        <div id="canvas"></div>
    </body>
    <script type="text/javascript">
        require(
            ["rere/rere"], 
            function(rere) {
                var renderer = rere.ui.renderer;
                var Variable = rere.reactive.Variable;
                var hacks = rere.ui.hacks;
                var rv = rere.reactive.rv;
                var H = rere.ui.renderer.h;

                var obj = {};
                obj.list = new rere.reactive.ObservableList([]);
                obj.toggleAll = new Variable();
                obj.leftCompleted = obj.list.lift(function(item){ return item.mark.lift(function(state){
                    return state ? [0,1] : [1,0];
                }); }).reduceCA(function(a,b){ return [a[0]+b[0], a[1]+b[1]]; });
                obj.activeTab = new Variable("All"); // All, Active, Completed

                var toggleEvent = rv.event(obj.toggleAll);
                var toggleAgg = rv.batch(obj.list.lift(function(item){ return item.mark; }).reduceCA(function(a,b){
                    return a && b;
                }).coalesce(false));

                obj.toggleAll.follows(toggleAgg);

                toggleEvent.bind(function(event){
                    return toggleAgg.bind(function(state){
                        return event==state ? new Variable() : new Variable(event);
                    });
                }).subscribe(function(change){
                    toggleAgg.batch();
                    obj.list.getData().map(function(item){
                        item.value.mark.set(change);
                    });
                    toggleAgg.commit();
                });

                renderer.render(canvas,
                ["div", 
                    ["@",["css", ["width", "500px"],["background-color", "azure"]]],
                    (function(){
                        var name = new Variable("");
                        return ["div",
                            ["form",
                                ["!", {submit: function(element, view, event){
                                    event.preventDefault();
                                    if (name.value().value()==="") return;
                                    obj.list.add(function(id){
                                        return {
                                            mark: new Variable(false),
                                            name: rv.batch(new Variable(name.value().value())),
                                            remove: function() { obj.list.remove(id); }
                                        };
                                    });
                                    name.set("");
                                }}],
                                ["input-text", name, ["@", ["placeholder", "What needs to be done?"]]]],
                            H(rv.when(obj.list.list, function(list) { return list.length > 0 }, H(
                                ["div", ["input-check", obj.toggleAll]]
                            ))),
                            H(obj.list.lift(function(item){
                                return H(ITEM(item))
                            })),
                            H(obj.leftCompleted.lift(function(v){
                                var html = ["div",
                                    ["span", "" + v[0] + " " + (v[0]===1? "item left" : "items left")],
                                    ["ul",
                                        ["li", tabSwitch("All")],
                                        ["li", tabSwitch("Active")],
                                        ["li", tabSwitch("Completed")]]
                                ];
                                if (v[1]>0) html.push(["button",
                                    ["!", {click: function(){}}],
                                    "Clear completed (" + v[1] + ")"
                                ]);
                                return H(html);

                                function tabSwitch(tabName) {
                                    return ["a",
                                        ["@",
                                            ["href", "#"],
                                            ["class", rv.when(obj.activeTab, tabName, "selected")]],
                                        ["!", {click: function() { obj.activeTab.set(tabName); }}],
                                        tabName
                                    ];
                                }
                            }))
                        ];
                    })()
                ]);

                function ITEM(item) {
                    var control = new Variable();
                    var label = hacks.unrecursion(function() {
                        control.set(H(renderer.parse(
                                ["div",
                                    ["input-check", item.mark],
                                    ["label",
                                        ["!", { dblclick: textbox }],
                                        ["@", ["css", [
                                            "text-decoration", rv.when(item.mark, true, "line-through", "none")]]],
                                        new rere.ui.Text(item.name)],
                                    ["button", ["!", {click: item.remove}]]]
                        )));
                        item.name.commit();
                    });
                    function textbox() {
                        item.name.batch();
                        control.set(H(renderer.parse(
                                ["form",
                                    ["!", {submit: function(element, view, event){
                                        event.preventDefault();
                                        label();
                                    }}],
                                    ["input-text", item.name.core, ["!", {blur: label}]]]
                        )));
                    }
                    label();
                    return H(control);
                }
            }
        );
    </script>
</html>
