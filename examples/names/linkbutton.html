<html>
    <head>
        <script src="../../rere.js"></script>
    </head>
    <body>
        <div id="canvas"></div>
    </body>
    <script type="text/javascript">
        rere.ui.renderer.addTag("linkbutton", function(opt) {
            var args = rere.ui.tags.utils.parseTagArgs(opt);
            var attr = rere.ui.tags.utils.normalizeAttributes(args.attr);

            var css = {};
            rere.ui.tags.utils.tryEnrich(css, attr.attributes.css);
            rere.ui.tags.utils.tryEnrich(css, {
                "text-decoration": "none",
                "border-bottom": "1px dashed",
                "color": "blue",
                "cursor": "pointer",
                "rere:disabled": {
                    "cursor": "default",
                    "color": "#585858"
                }
            });

            var disabled;
            if ("rere:disabled" in attr.attributes) {
                disabled = attr.attributes["rere:disabled"];
                if (typeof disabled=="boolean") disabled = new Cell(disabled);
                delete attr.attributes["rere:disabled"];
            } else {
                disabled = new Cell();
            }
            disabled = disabled.coalesce(false);

            var click = attr.events.click ? attr.events.click : function(){};
            attr.events.click = function() {
                if (disabled.unwrap()) return;
                click();
            };

            for (var key in css["rere:disabled"]) {
                if (!css["rere:disabled"].hasOwnProperty(key)) continue;
                if (!css.hasOwnProperty(key)) throw new Error(key + " in css/rere:disabled but not in css");
                css[key] = disabled.when(false, css[key]).coalesce(css["rere:disabled"][key]);
            }
            delete css["rere:disabled"];

            attr.attributes.css = css;
            attr.attributes.href = "#";

            attr = rere.ui.tags.utils.denormalizeAttributes(attr);

            return rere.ui.renderer.parse(["a", attr, args.attr==null ? opt[0] : opt[1]]);
        });


        var Cell = rere.reactive.Cell;

        function NAME(firstName, lastName) {
            firstName = new Cell(firstName);
            lastName = new Cell(lastName);
            var fullName = firstName.bind(function(first){
                return lastName.bind(function(last){
                    return new Cell(first + " " + last);
                });
            });
            var disabled = new Cell(false);
            return ["div",
                ["linkbutton", {
                    "rere:disabled": disabled,
                    "!click": function() {
                        firstName.unset();
                        lastName.unset();
                        disabled.set(true);
                    }
                }, "click me"],
                ["div",
                    "First name:", ["input-text", firstName]],
                ["div",
                    "Last name:", ["input-text", lastName]],
                ["div", fullName]
            ];
        }

        var renderer = rere.ui.renderer;
        renderer.render(canvas, NAME("Denis", "Rystsov"));
    </script>
</html>
