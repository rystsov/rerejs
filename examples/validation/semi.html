<html>
<head>
    <script src="../../lib/warp9/warp9.js"></script>
</head>
<body>
<div id="placeholder"></div>
</body>
<script type="text/javascript">
    addVF(warp9);

    var email = new warp9.Cell();
    warp9.render(placeholder, ["div",
        inputEmail(email),
        ["validation", email, function(message){
            return ["div", {"class": "error"}, message];
        }]
    ]);

    function addVF(warp9) {
        warp9.ui.renderer.addTag("validation", function(args) {
            var value = args[0];
            var builder = args[1];
            return warp9.ui.renderer.parse(value.when(
                    function(value) { return !value.isValid; },
                    function(value) { return builder(value.message); }
            ));
        });
    }

    function inputEmail(email) {
        return new warp9.ui.Component(function(){
            if (!email.hasValue()) {
                email.set(checkEmail(""));
            }
            var input = new warp9.Cell();
            var dispose = [];
            dispose.push(email.onChange(function(){
                if (input.hasValue() && input.get()==email.get().value) return;
                input.set(email.get().value);
            }));
            dispose.push(input.onChange(function(){
                email.set(checkEmail(input.get()));
            }));
            this.dispose = function() {
                dispose.forEach(function(f) { f(); });
            };
            return ["input-text", input];
        });
    }

    function checkEmail(value) {
        var obj = {
            isValid: value.indexOf("@") > 0 && value.indexOf("@") + 1 < value.length,
            value: value
        };
        if (!obj.isValid) {
            if (value.length==0) {
                obj.message = "You should enter a valid email";
            } else {
                obj.message = "\"" + value + "\" is not a valid email";
            }
        }
        return obj;
    }
</script>
</html>
