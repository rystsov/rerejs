<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Wapr9 / Docs / Custom tags</title>

    <link href="../../lib/highlight.js/styles/default.css" rel="stylesheet" >
    <script src="../../lib/highlight.js/highlight.pack.js"></script>

    <!-- Bootstrap core CSS -->
    <link href="../../lib/bootstrap/css/bootstrap.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="../../css/common.css" rel="stylesheet">
    <link href="../../css/docs.css" rel="stylesheet">
    <link href="../../css/custom_tags.css" rel="stylesheet">
</head>

<body>

<div class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <a class="navbar-brand" href="../../index.html">WARP9</a>
        </div>
        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="docs.html">Docs</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Competitor analysis <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="../competitors/matrix.html">Matrix</a></li>
                        <li class="divider"></li>
                        <li><a href="../competitors/leaks/leaks.html">Accidental memory leaks</a></li>
                        <li><a href="../competitors/diamond/diamond.html">Repeated diamonds shape</a></li>
                        <li><a href="../competitors/consistency/consistency.html">Atomic updates</a></li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Examples <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="../../examples/todomvc/todomvc.html">TodoMVC</a></li>
                    </ul>
                </li>
                <li><a href="../download.html">Download</a></li>
                <li><a href="https://github.com/rystsov/warp9">Sources</a></li>
            </ul>
        </div>
    </div>
</div>

<div id="docs" class="container">
    <div class="row">
        <div class="col-md-3">
            <ul class="nav nav-pills nav-stacked">
                <li><a href="docs.html">Basic idea</a></li>
                <li><a href="reactive_primitives.html">Reactive primitives</a></li>
                <li><a href="markup.html">Markup</a></li>
                <li><a href="components.html">Components</a></li>
                <li class="active"><a href="custom_tags.html">Custom tags</a></li>
            </ul>
        </div>
        <div class="col-md-9">
            <h3>Custom tags</h3>
            <p>
                When you ask Wapr9 to render a z-expression with <code>warp9.render</code> it
                parses the z-expression into a tree (reactive DOM), where each node may be
                either an Element (which corresponds to a html tag) or a reactive variable. Of
                cause an Element may have children (another nodes) represented as a js array or
                as a reactive list. A reactive variable's value is a subtree of a tree.
            </p>
            <p>
                When parser recognises a z-expression, it takes the first value (pseudo tag)
                and search a sub parser that can parse that z-expression. Warp9 provides a
                way to register a new sub parser to process new z-expression, so this a way
                you can introduce a new custom tag.
            </p>
            <h4>Validation framework</h4>
            <p>
                Lets reinvent a simple validation framework to understand how to create custom tags.
                You may notice, that <code>["input-text", rv]</code> is a textbox which updates a
                reactive variable <code>rv</code> with textbox's value on each textbox update. Lets
                imagine a <code>["input-email", rv]</code>, a textbox which does a email validation and
                writes to rv textbox's value, a validation flag and an error message if needed.
                Something similar to:
            </p>
            <pre><code class="json">{
    isValid: true,
    value: "email@example.org"
}</code></pre>
            <p>or</p>
            <pre><code class="json">{
    isValid: true,
    value: "email@",
    message: "\"email@\" is not a valid email"
}</code></pre>
            <p>
                Also image we have a tag to display and decorate a validation message:
            </p>
            <pre><code>["validation", rv, function(message){
    return ["div", {"class": "error"}, message];
}]</code></pre>
            <p>
                Having this we may write a simple UI piece to validate email
            </p>
            <div class="app" >
                <div id="placeholder"></div>
            </div>
            <p>
                And it's source might be similar to
            </p>
            <pre><code>var email = new warp9.Cell();
warp9.render(placeholder, ["div",
    ["input-email", email],
    ["validation", email, function(message){
        return ["div", {"class": "error"}, message];
    }]
]);</code></pre>
            <p>
                Lets implement this and with an approach you already know - with functions. The code for
                UI piece would transform into
            </p>
            <pre><code>var email = new warp9.Cell();
warp9.render(placeholder, ["div",
    inputEmail(email),
    validation(email, function(message){
        return ["div", {"class": "error"}, message];
    })
]);</code></pre>
            <p>
                The
                <a href="https://github.com/rystsov/warp9/blob/gh-pages/examples/validation/functions.html">full sources</a>
                of function based VF is available. But I want to focus you attention to <code>validation</code> method,
                which is the first to be rewritten to custom tag.
            </p>
            <pre><code>function validation(value, builder) {
    return value.when(
            function(value) { return !value.isValid; },
            function(value) { return builder(value.message); }
    )
}</code></pre>
            <p>
                Above all we must register a new sub-parser for "validation" tag, it can be done with
                <code>warp9.ui.renderer.addTag</code> method. A provided handler will be called by the
                parser each time it meets <code>["validator", ...]</code> and the handler must return a
                reactive DOM which becomes sub-tree in the final reactive DOM.
            </p>
            <pre><code>warp9.ui.renderer.addTag("validation", function(args) {
    return ...
});</code></pre>
            <p>
                <code>args</code> is the tail of <code>["validator", ...]</code> array. For example
                if a z-expression is <code>["validator", a, b]</code> then the <code>args</code> is
                <code>[a, b]</code>. Also you should know that <code>warp9.ui.renderer.parse</code> is
                the entry point for the parser. Now we have all information to fill the ellipsis.
            </p>
            <pre><code>warp9.ui.renderer.addTag("validation", function(args) {
    var value = args[0];
    var builder = args[1];
    return warp9.ui.renderer.parse(value.when(
            function(value) { return !value.isValid; },
            function(value) { return builder(value.message); }
    ));
});</code></pre>
            <p>
                Actually it is direct a wrap of validation function-like component into a custom tag.
                Translation of <code>inputEmail</code> is far more interesting - we will construct
                an Element I mentioned before. The full sources are
                <a href="https://github.com/rystsov/warp9/blob/gh-pages/examples/validation/tags.html">available</a>,
                here is the main part, I hope this code will be clear to you find my comments below.
            </p>
            <pre><code>warp9.ui.renderer.addTag("input-email", function(args) {
    args = warp9.ui.tags.args.parse(args);
    args = warp9.ui.tags.args.tryIntercept("input-email", args);

    if (args.children.length != 1) {
        throw new Error();
    }
    if (!warp9.core.Matter.instanceOf(args.children[0], warp9.Cell)) {
        throw new Error();
    }

    if (!args.children[0].hasValue()) {
        args.children[0].set(checkEmail(""));
    }

    var element = new warp9.ui.ast.Element("input", args);
    element.attributes.type = "text";
    element.attributes.value = args.children[0].lift(function(validated){
        return validated.value;
    });
    element.events.input = function(control, view) {
        args.children[0].set(checkEmail(view.value));
    };

    return element;

    function checkEmail(value) {
        ...
    }
});</code></pre>
        <p>
            <code>warp9.ui.tags.args.parse</code> tries to reinterpret the first element as a
            element attributes (attributes, css, events). For example, if the args is
        </p>
        <pre><code>[{id: 15, "css/margin": "5px", "!click": function() {...} }, b]</code></pre>
        <p>the output of warp9.ui.tags.args.parse is</p>
        <pre><code>{
    events: {
        click: function() {...}
    },
    // onDraw has "warp9:draw" handler if it is provided
    onDraw: [],
    attributes: {
        id: 15
    },
    css: {
        margin: "5px"
    },
    children: [b]
}</code></pre>
            <p>
                if the args is <code>[a, b]</code> and "a" cant be interpreted as a set of
                attributes then the output is
            </p>
            <pre><code>{
    events: { },
    onDraw: [],
    attributes: { },
    css: { },
    children: [a, b]
}</code></pre>
            <p>
                <code>warp9.ui.tags.args.tryIntercept</code> is an another way to provide
                Warp9's extensibility. You can register a handler which shuffles
                attributes for a specific tag. For example, custom event "key:enter" is
                mapped to keypress with filter via tryIntercept.
            </p>
            <p>
                <code>new warp9.ui.ast.Element("input", args);</code> constructs a new element
                which corresponds to html "input" tag and sets attributes (css, events) from args
                object (but not children).
            </p>
        </div>
    </div>
</div>


<script src="../../lib/jquery/jquery-2.0.3.min.js"></script>
<script src="../../lib/bootstrap/js/bootstrap.min.js"></script>
<script src="../../lib/warp9/warp9.js"></script>
<script language="JavaScript">
    hljs.initHighlightingOnLoad();

    addVF(warp9);

    var email = new warp9.Cell();
    warp9.render(placeholder, ["div",
        ["input-email", email],
        ["validation", email, function(message){
            return ["div", {"class": "error"}, message];
        }]
    ]);

    function addVF(warp9) {
        warp9.ui.renderer.addTag("validation", function(args) {
            var value = args[0];
            var builder = args[1];
            return warp9.ui.renderer.parse(value.when(
                    function(value) { return !value.isValid; },
                    function(value) { return builder(value.message); }
            ));
        });

        warp9.ui.renderer.addTag("input-email", function(args) {
            args = warp9.ui.tags.args.parse(args);
            args = warp9.ui.tags.args.tryIntercept("input-email", args);

            if (args.children.length != 1) {
                throw new Error();
            }
            if (!warp9.core.Matter.instanceOf(args.children[0], warp9.Cell)) {
                throw new Error();
            }

            if (!args.children[0].hasValue()) {
                args.children[0].set(checkEmail(""));
            }

            var element = new warp9.ui.ast.Element("input", args);
            element.attributes.type = "text";
            element.attributes.value = args.children[0].lift(function(validated){
                return validated.value;
            });
            element.events.input = function(control, view) {
                args.children[0].set(checkEmail(view.value));
            };

            return element;

            function checkEmail(value) {
                var obj = {
                    isValid: value.indexOf("@") > 0 && value.indexOf("@") + 1 < value.length,
                    value: value
                };
                if (!obj.isValid) {
                    if (value.length==0) {
                        obj.message = "You should enter a valid email";
                    } else {
                        obj.message = "\"" + value + "\" is not a valid email";
                    }
                }
                return obj;
            }
        });
    }
</script>
</body>
</html>
