<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Wapr9 / Repeated diamonds shape / Knockout</title>

    <link href="../../../lib/highlight.js/styles/default.css" rel="stylesheet" >
    <script src="../../../lib/highlight.js/highlight.pack.js"></script>
    <script src="../../../lib/highlight.hack.js"></script>

    <link href="../../../lib/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="../../../css/common.css" rel="stylesheet">
    <link href="diamond.css" rel="stylesheet">
</head>

<body>

<div class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <a class="navbar-brand" href="../../../index.html">WARP9</a>
        </div>
        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="../../docs/docs.html">Docs</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Competitor analysis <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="../matrix.html">Matrix</a></li>
                        <li class="divider"></li>
                        <li><a href="../leaks/leaks.html">Accidental memory leaks</a></li>
                        <li><a href="../diamond/diamond.html">Repeated diamonds shape</a></li>
                        <li><a href="../consistency/consistency.html">Atomic updates</a></li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Examples <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        <li><a href="../../../examples/todomvc/todomvc.html">TodoMVC</a></li>
                    </ul>
                </li>
                <li><a href="../../download.html">Download</a></li>
                <li><a href="https://github.com/rystsov/warp9">Sources</a></li>
                <li><a href="https://groups.google.com/group/warp9">Forum</a></li>
            </ul>
        </div>
    </div>
</div>

<div class="container">
    <!-- Main component for a primary marketing message or call to action -->
    <div class="jumbotron">
        <h1>Repeated diamonds shape</h1>
        <p>
            You can avoid repeated diamonds shape problem with Knockout by using throttling,
            but before you start looking for for a solution you should know about the
            problem.
        </p>
        <p>
            <a class="btn btn-lg btn-primary btn-info" href="diamond.html">Details</a>
            <a class="btn btn-lg btn-primary btn-warning" href="knockout.html">Knockout</a>
            <a class="btn btn-lg btn-primary" href="reactive_coffee.html">Reactive Coffee</a>
            <a class="btn btn-lg btn-primary" href="warp9.html">Warp9</a>
        </p>
    </div>
</div>

<div class="container">
    <div class="starter-template">
        <div class="row">
            <div class="col-md-6">
                <div class="app">
                    <p>
                        Enter number of "diamonds" from source to target and click "Calc updates" to
                        calculate how much times the target will be updated when the source is updated.
                    </p>
                    <div class="knockout">
                        <div>
                            <label for="in">Enter number of diamonds:</label>
                            <input id="in" type="text" data-bind="value: diamonds" />
                            <button data-bind="click: update">Calc updates</button>
                        </div>
                        <span data-bind="text: result"></span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <p>HTML</p>
                <pre><code id="html"><!--<div>
    <label for="in">Enter number of diamonds:</label>
    <input id="in" type="text" data-bind="value: diamonds" />
    <button data-bind="click: update">Calc updates</button>
</div>
<span data-bind="text: result"></span>--></code></pre>

                <p>JS</p>
                <pre><code>var model = new ViewModel();
model.update();
ko.applyBindings(model);

function ViewModel() {
    this.diamonds = ko.observable("2");
    this.result = ko.observable();

    this.update = function() {
        var value = parseInt(this.diamonds());
        if (value>0) {
            var source = ko.observable(1);
            var target = repeatDiamondShape(source, value);

            var updates = 0;
            var handler = target.subscribe(function(){
                updates++;
            });
            updates = 0;
            source(2);
            handler.dispose();
            this.result("Expected one update, but got "+updates);
        } else {
            this.result("Should be an integer above 0");
        }
    }
}

function repeatDiamondShape(seed, n) {
    if (n==0) return seed;
    var s1 = ko.computed(function(){ return seed() + 1; });
    var s2 = ko.computed(function(){ return seed() + 1; });
    return repeatDiamondShape(ko.computed(function(){
        return s1() + s2();
    }), n-1);
}</code></pre>
            </div>
        </div>
    </div>
</div>


<script src="../../../lib/jquery/jquery-2.0.3.min.js"></script>
<script src="../../../lib/bootstrap/js/bootstrap.min.js"></script>
<script src="../../../lib/knockout/knockout-3.0.0rc.js"></script>

<script language="JavaScript">
    hljs.initHighlightingOnLoad();
    uncommentAndHighlight(html);

    var model = new ViewModel();
    model.update();
    ko.applyBindings(model);

    function ViewModel() {
        this.diamonds = ko.observable("2");
        this.result = ko.observable();

        this.update = function() {
            var value = parseInt(this.diamonds());
            if (value>0) {
                var source = ko.observable(1);
                var target = repeatDiamondShape(source, value);
                var updates = 0;
                var handler = target.subscribe(function(){
                    updates++;
                });
                updates = 0;
                source(2);
                handler.dispose();
                this.result("Expected one update, but got " + updates);
            } else {
                this.result("Should be an integer above 0");
            }
        }
    }

    function repeatDiamondShape(seed, n) {
        if (n==0) return seed;
        var s1 = ko.computed(function(){ return seed() + 1; });
        var s2 = ko.computed(function(){ return seed() + 1; });
        return repeatDiamondShape(ko.computed(function(){
            return s1() + s2();
        }), n-1);
    }
</script>
</body>
</html>
